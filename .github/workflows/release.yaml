name: Release Dev Container Features
on:
  workflow_dispatch: {}
jobs:
  deploy:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      packages: write
    steps:
    - uses: actions/checkout@v4
    - name: Publish Features
      uses: devcontainers/action@v1
      with:
        publish-features: true
        base-path-to-features: ./src
        generate-docs: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Create PR for Documentation
      id: push_image_info
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "set -e\necho \"Start.\"\n\n# Create new branch for documentation updates\n\
        branch=automated-documentation-update-$GITHUB_RUN_ID\necho \"Creating branch:\
        \ $branch\"\n\n# Create branch via API (this will be automatically signed)\n\
        gh api \\\n  --method POST \\\n  /repos/$GITHUB_REPOSITORY/git/refs \\\n \
        \ -f ref=\"refs/heads/$branch\" \\\n  -f sha=\"$GITHUB_SHA\"\n\nmessage='Automated\
        \ documentation update [skip ci]'\n\n# Find all updated README.md files\n\
        readmes=$(find . -name \"README.md\" -path \"*/*/README.md\")\n\n# Check if\
        \ any README files were found\nif [ -z \"$readmes\" ]; then\n  echo \"No README\
        \ files found to update\"\n  exit 0\nfi\n\n# Commit each README file via GitHub\
        \ API (automatically signed)\nfor readme in $readmes; do\n  # Get the current\
        \ file from the source branch to get its SHA\n  file_path=${readme:2}  # Remove\
        \ leading ./\n  echo \"Committing updates to $file_path\"\n  \n  # Get current\
        \ file SHA from the new branch\n  file_sha=$(gh api \\\n    --method GET \\\
        \n    /repos/$GITHUB_REPOSITORY/contents/$file_path?ref=main \\\n    -q '.sha')\n\
        \  \n  echo \"SHA for $file_path: $file_sha\"\n  \n  # Use GitHub API to commit\
        \ the file (automatically signed)\n  gh api \\\n    --method PUT \\\n    /repos/$GITHUB_REPOSITORY/contents/$file_path\
        \ \\\n    -f message=\"$message\" \\\n    -f content=\"$(base64 -i $readme)\"\
        \ \\\n    -f sha=\"$file_sha\" \\\n    -f branch=\"$branch\" \\\n    || echo\
        \ \"No changes to commit for $file_path\"\ndone\n\n# Create PR\ngh pr create\
        \ --title \"$message\" --body \"$message\" --head \"$branch\" --base \"main\"\
        \ || echo \"No changes to create PR for\"\n"
